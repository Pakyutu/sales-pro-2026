<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEDIA SWARA PRIMA</title>
    
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#EE2D24">
    
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">

    <style>
        :root {
            --tsel-red: #EE2D24;
            --tsel-dark: #121212;
            --tsel-silver: #f8f9fa;
            --tsel-gold: #FFB81C;
            --glass: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] {
            --tsel-silver: #0a0a0a;
            --glass: rgba(20, 20, 20, 0.95);
            --tsel-dark: #ffffff;
        }
        
        body { font-family: 'Inter', -apple-system, sans-serif; padding: 0; margin: 0; background: var(--tsel-silver); color: var(--tsel-dark); transition: 0.4s; overflow-x: hidden; }
        
        /* HEADER */
        .header-main { 
            background: linear-gradient(135deg, #EE2D24 0%, #800000 50%, #000000 100%); 
            color: white; padding: 60px 20px; text-align: center; 
            border-radius: 0 0 60px 60px; box-shadow: 0 20px 60px rgba(238, 45, 36, 0.6);
            position: relative; overflow: hidden;
        }
        .header-main::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 15s linear infinite;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .header-main h1 { margin: 0; font-size: 30px; letter-spacing: 3px; font-weight: 900; text-shadow: 0 5px 20px rgba(0,0,0,0.6); position: relative; z-index: 1; }
        .header-main p { margin: 8px 0 0; font-size: 11px; font-weight: 800; letter-spacing: 5px; color: var(--tsel-gold); text-transform: uppercase; position: relative; z-index: 1; }

        .theme-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; padding: 12px; border-radius: 15px; cursor: pointer; backdrop-filter: blur(10px); z-index: 10; }

        .tabs-container { 
            display: flex; background: var(--glass); margin: -35px 20px 10px; border-radius: 25px; 
            padding: 8px; box-shadow: 0 10px 40px rgba(238, 45, 36, 0.3); position: sticky; top: 15px; z-index: 999; 
            backdrop-filter: blur(20px); border: 2px solid rgba(238, 45, 36, 0.3); overflow-x: auto;
        }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: #777; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 10px; transition: 0.3s; border-radius: 20px; white-space: nowrap; }
        .tab-btn.active { background: var(--tsel-red); color: white; box-shadow: 0 8px 25px rgba(238, 45, 36, 0.4); }
        
        .content { padding: 20px; display: none; animation: slideUp 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); padding-bottom: 100px; }
        .content.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--glass); padding: 30px; border-radius: 35px; box-shadow: 0 10px 40px rgba(238, 45, 36, 0.3); 
            margin-bottom: 25px; border: 1px solid rgba(238, 45, 36, 0.15); backdrop-filter: blur(15px); 
            position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, #EE2D24, #000); }

        h3 { margin-top: 0; color: var(--tsel-red); font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 25px; font-weight: 900; }
        
        label { display: block; font-weight: 800; margin-bottom: 10px; font-size: 11px; color: #888; text-transform: uppercase; }
        input, select { 
            width: 100%; padding: 18px; border: 2px solid rgba(128,128,128,0.1); border-radius: 20px; 
            box-sizing: border-box; font-size: 16px; margin-bottom: 20px; font-weight: 700; 
            background: rgba(128,128,128,0.05); color: var(--tsel-dark); transition: 0.3s; 
        }
        
        .btn { 
            border: none; border-radius: 22px; font-weight: 900; cursor: pointer; text-transform: uppercase; 
            padding: 22px; width: 100%; transition: 0.3s; font-size: 13px; letter-spacing: 2px; 
        }
        .btn-black { background: #000; color: white; }
        .btn-tsel { background: linear-gradient(135deg, #EE2D24 0%, #b31d16 100%); color: white; box-shadow: 0 10px 30px rgba(238, 45, 36, 0.4); }

        /* BUTTONS ACTION KECIL */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 20px; }
        .btn-action { 
            border: none; border-radius: 12px; font-weight: 800; cursor: pointer; 
            padding: 10px; width: 100%; font-size: 10px; color: white; 
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .act-struk { background: #EE2D24; }
        .act-edit { background: #7f8c8d; }
        .act-del { background: #c0392b; }

        /* STRUK THERMAL STYLE */
        #receiptOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 99999; overflow-y: auto; 
            padding-top: 50px; padding-bottom: 100px; 
        }
        
        .receipt-box { 
            background: #fff; width: 85%; max-width: 350px; margin: 0 auto; 
            color: #000; padding: 25px; box-shadow: 0 10px 30px rgba(255,255,255,0.1);
            font-family: 'Courier New', Courier, monospace; 
            position: relative; border-radius: 5px;
        }
        .receipt-box::after {
            content: ""; position: absolute; left: 0; bottom: -10px; width: 100%; height: 10px;
            background: radial-gradient(circle, transparent 70%, #fff 70%) 0 0;
            background-size: 20px 20px; transform: rotate(180deg);
        }

        .r-header { text-align: center; margin-bottom: 20px; }
        .r-header h2 { font-size: 18px; margin: 5px 0; text-transform: uppercase; letter-spacing: 1px; color: #000; }
        .r-info { text-align: center; font-size: 11px; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 10px; }
        
        .struk-table { width: 100%; font-size: 12px; margin-bottom: 10px; }
        .struk-table td { padding: 4px 0; vertical-align: top; }
        .struk-table .col-item { text-align: left; width: 60%; font-weight: bold; }
        .struk-table .col-price { text-align: right; width: 40%; }

        .r-dashed { border-top: 1px dashed #000; margin: 10px 0; }
        .r-total-row { display: flex; justify-content: space-between; font-weight: 900; font-size: 16px; margin-top: 15px; color: #000; }
        .r-footer { text-align: center; margin-top: 20px; font-size: 10px; color: #444; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .dash-item { padding: 22px; border-radius: 25px; color: white; position: relative; }
        .dash-item.green { background: linear-gradient(135deg, #16a085, #2ecc71); }
        .dash-item.blue { background: linear-gradient(135deg, #2980b9, #3498db); }
        .dash-item span { font-size: 10px; font-weight: 800; text-transform: uppercase; opacity: 0.9; }
        .dash-item b { font-size: 18px; display: block; margin-top: 8px; }

        .stok-table { width: 100%; border-collapse: collapse; }
        .stok-table th { text-align: left; color: #888; font-size: 10px; padding-bottom: 15px; text-transform: uppercase; }
        .stok-table td { padding: 18px 0; border-bottom: 1px solid rgba(128,128,128,0.1); font-weight: 700; font-size: 14px; }
        
        /* STYLE KHUSUS TAB RIWAYAT */
        .hist-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid rgba(128,128,128,0.1); align-items: center; }
        .hist-date { font-size: 14px; font-weight: 900; }
        .hist-total { font-size: 14px; font-weight: 900; color: var(--tsel-red); text-align: right; }
        .hist-detail { font-size: 10px; color: #888; margin-top: 4px; }
        .btn-view { border: none; background: #000; color: white; padding: 5px 10px; border-radius: 8px; font-size: 9px; font-weight: bold; cursor: pointer; margin-left: 10px;}
    </style>
</head>
<body data-theme="light">

    <div class="header-main">
        <button class="theme-btn" onclick="toggleTheme()">üåì</button>
        <p>TELKOMSEL AUTHORIZED PARTNER</p>
        <h1>MEDIA SWARA PRIMA</h1>
    </div>

    <div id="receiptOverlay">
        <div class="receipt-box">
            <div class="r-header">
                <p style="margin:0; font-size:10px;">TELKOMSEL AUTHORIZED PARTNER</p>
                <h2>MEDIA SWARA PRIMA</h2>
                <p style="margin:0; font-size:10px;">TAP BAGAN BATU</p>
            </div>
            
            <div class="r-info">
                <span id="rDateDisp"></span><br>
                <b id="rOutletName" style="text-transform: uppercase; font-size:14px;">OUTLET</b>
            </div>
            
            <table class="struk-table">
                <tbody id="rItemsList"></tbody>
            </table>

            <div class="r-dashed"></div>
            
            <div class="r-total-row">
                <span>TOTAL BAYAR</span>
                <span id="rTotalAmount">0</span>
            </div>
            
            <div class="r-footer">
                <p>SIMPAN STRUK SEBAGAI BUKTI PEMBAYARAN</p>
                <p>*** TERIMA KASIH ***</p>
            </div>
        </div>
        
        <div style="padding: 20px; display: flex; gap: 10px; justify-content: center; position: relative; z-index: 100000;">
            <button class="btn btn-black" style="padding: 15px 30px;" onclick="closeReceipt()">TUTUP</button>
            <button id="waBtn" class="btn btn-tsel" style="padding: 15px 30px; background: #25D366;">KIRIM WA</button>
        </div>
    </div>

    <div class="tabs-container">
        <button class="tab-btn active" onclick="openTab('tab1', this)">üõí PENJUALAN</button>
        <button class="tab-btn" onclick="openTab('tab4', this)">üìÖ RIWAYAT</button>
        <button class="tab-btn" onclick="openTab('tab2', this)">üìà ANALISA</button>
        <button class="tab-btn" onclick="openTab('tab3', this)">‚öôÔ∏è STOK</button>
    </div>

    <div id="tab1" class="content active">
        <div class="card">
            <h3 style="border-left: 5px solid var(--tsel-red); padding-left: 10px;">üî¥ INPUT TRANSAKSI</h3>
            <label>TANGGAL TRANSAKSI (UNTUK DATA BARU)</label>
            <input type="date" id="tanggalInput">
            
            <label>NAMA OUTLET</label>
            <input type="text" id="namaOutlet" placeholder="Masukkan Nama Outlet">
            <label>METODE PEMBAYARAN</label>
            <select id="metodeBayar">
                <option value="CASH">üí∞ CASH / TUNAI</option>
                <option value="TRANSFER">üè¶ TRANSFER BANK</option>
            </select>
            <label>PILIH PRODUK (VCR / SALDO)</label>
            <select id="pilihanVoucher" onchange="updateHarga()"></select>
            <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 15px;">
                <div><label id="labelHarga">HARGA JUAL</label><input type="text" id="hargaDisplay" oninput="formatInput(this)"></div>
                <div><label id="labelQty">QTY (PCS / NOMINAL)</label><input type="text" id="jumlahPcs" placeholder="0" oninput="formatInput(this)" inputmode="numeric"></div>
            </div>
            <button class="btn btn-black" onclick="addItem()">+ TAMBAHKAN KE DAFTAR</button>
            <div id="tempList" style="margin-top: 20px;"></div>
            <button class="btn btn-tsel" id="mainSaveBtn" style="margin-top:20px;" onclick="saveTrx()">üíæ SIMPAN TRANSAKSI SELESAI</button>
        </div>
        
        <div style="margin-bottom: 15px; background: var(--glass); padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid var(--tsel-red);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label style="margin:0; color:var(--tsel-red);">üìÇ LIHAT DATA LAMA:</label>
                <button class="btn-action act-edit" onclick="setTgl()" style="width:auto; padding:5px 10px;">HARI INI</button>
            </div>
            <input type="date" id="filterTgl" onchange="renderAll()" style="margin-bottom: 0; margin-top:10px; background:white;">
            <p style="font-size:10px; color:#888; margin-top:5px; text-align:center;">*Pilih tanggal untuk melihat detail penjualan hari tersebut</p>
        </div>

        <div id="historyList"></div>

        <div class="dash-grid">
            <div class="dash-item green"><span>TOTAL CASH</span><b id="statCash">0</b></div>
            <div class="dash-item blue"><span>TOTAL TF</span><b id="statTf">0</b></div>
            <div class="dash-item" style="background:#121212; grid-column: span 2; padding: 25px; border: 2px solid var(--tsel-red); text-align: center;">
                <span id="statTitle" style="color:var(--tsel-red); font-weight: 900; letter-spacing: 2px;">TOTAL HARI INI</span>
                <b id="statGrand" style="font-size: 32px; color: white; margin-top: 10px;">0</b>
            </div>
        </div>
        <button class="btn btn-black" onclick="copyReport()">üìã SALIN LAPORAN HARIAN</button>
    </div>
    
    <div id="tab4" class="content">
        <div class="card">
            <h3>üìÖ RIWAYAT OMSET HARIAN</h3>
            <p style="font-size:11px; color:#666; margin-bottom:15px;">Klik tombol <b>LIHAT DETAIL</b> untuk membuka data lengkap tanggal tersebut.</p>
            <div id="riwayatList"></div>
        </div>
    </div>

    <div id="tab2" class="content">
        <div class="card">
            <h3>üî• PRODUK TERLARIS</h3>
            <div id="bestSellerGrid"></div>
        </div>
        <div class="card">
            <h3>üì¶ MONITORING STOK</h3>
            <div style="overflow-x: auto;">
                <table class="stok-table">
                    <thead><tr><th>PRODUK</th><th>AWAL</th><th>LAKU</th><th>SISA</th></tr></thead>
                    <tbody id="stokTableBody"></tbody>
                </table>
            </div>
            <button class="btn btn-black" style="margin-top: 15px;" onclick="copyStockReport()">üìã SALIN DATA STOK</button>
        </div>
    </div>

    <div id="tab3" class="content">
        <div class="card">
            <h3>üõ†Ô∏è STOK AWAL</h3>
            <div id="stokEditor"></div>
        </div>
        <div class="card">
            <h3>üé® KATALOG PRODUK</h3>
            <label>NAMA PRODUK</label><input type="text" id="addName" placeholder="">
            <label>HARGA DEFAULT</label><input type="text" id="addPrice" oninput="formatInput(this)">
            <button class="btn btn-black" onclick="addKatalog()">‚ûï TAMBAH KE KATALOG</button>
            <div id="catalogList" style="margin-top: 25px;"></div>
        </div>
        <div class="card">
            <h3>‚öôÔ∏è SYSTEM</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-black" style="font-size: 10px;" onclick="exportData()">üì• DOWNLOAD</button>
                <button class="btn btn-black" style="font-size: 10px;" onclick="document.getElementById('fileIn').click()">üì§ UPLOAD</button>
            </div>
            <input type="file" id="fileIn" hidden onchange="importData(event)">
            <button class="btn" style="background:transparent; color:red; font-size:10px; margin-top:20px;" onclick="hardReset()">‚ö†Ô∏è FORMAT DATA</button>
        </div>
    </div>

<script>
    let db = {
        catalog: JSON.parse(localStorage.getItem('MSP_CATALOG')) || [
            {nama: "4GB 1H", harga: 6200},
            {nama: "5GB 2H", harga: 8200},
            {nama: "4GB 3H", harga: 11800},
            {nama: "3GB 5H", harga: 12900},
            {nama: "8GB 5H", harga: 22500},
            {nama: "12GB 30H", harga: 37000},
            {nama: "SA 3GB", harga: 30000},
            {nama: "SA BYU 3GB", harga: 30000},
            {nama: "LINKAJA", harga: 1}, 
            {nama: "SEVEN", harga: 1}
        ],
        rekap: JSON.parse(localStorage.getItem('MSP_REKAP')) || [],
        stok: JSON.parse(localStorage.getItem('MSP_STOK')) || {}
    };

    let tempItems = [];
    let editIdx = -1;

    window.onload = () => { 
        setTgl(); 
        renderAll(); 
        renderRiwayat();
    };

    function saveToDisk() {
        localStorage.setItem('MSP_CATALOG', JSON.stringify(db.catalog));
        localStorage.setItem('MSP_REKAP', JSON.stringify(db.rekap));
        localStorage.setItem('MSP_STOK', JSON.stringify(db.stok));
    }

    function renderAll() {
        const sel = document.getElementById('pilihanVoucher');
        sel.innerHTML = db.catalog.map(v => `<option value="${v.harga}">${v.nama}</option>`).join('');
        updateHarga();

        // LOGIKA FILTER TANGGAL
        let filterTgl = document.getElementById('filterTgl').value;
        let tglParts = filterTgl.split('-');
        let filterTglFormatted = tglParts[2] + '-' + tglParts[1] + '-' + tglParts[0];

        let gt = 0, tc = 0, tf = 0;
        let laku = {}; db.catalog.forEach(v => laku[v.nama] = 0);

        // Hanya tampilkan data sesuai tanggal filter
        let filteredData = db.rekap.filter(item => item.tgl === filterTglFormatted);

        document.getElementById('historyList').innerHTML = filteredData.map((ot, i) => {
            let originalIndex = db.rekap.indexOf(ot);
            const sub = ot.items.reduce((a, b) => { 
                return a + (b.harga * b.qty); 
            }, 0);
            gt += sub; 
            if(ot.metode === "CASH") tc += sub; else tf += sub;

            return `
                <div class="card" style="padding:20px; border-radius:25px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between;">
                        <div>
                            <b style="font-size:18px;">${ot.nama}</b>
                            <div style="font-size:10px; color:#888; margin-top:5px;">${ot.metode} | ${ot.jam || '--:--'}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:900; color:var(--tsel-red); font-size:20px;">RP ${formatRibuan(sub)}</div>
                        </div>
                    </div>
                    
                    <div class="action-grid">
                        <button class="btn-action act-struk" onclick="showStruk(${originalIndex})">üßæ STRUK</button>
                        <button class="btn-action act-edit" onclick="editTrx(${originalIndex})">‚úèÔ∏è EDIT</button>
                        <button class="btn-action act-del" onclick="delTrx(${originalIndex})">üóëÔ∏è HAPUS</button>
                    </div>
                </div>`;
        }).reverse().join('');

        // Update Judul & Angka Statistik
        let today = new Date().toISOString().slice(0, 10);
        let titleStat = (filterTgl === today) ? "TOTAL HARI INI" : "TOTAL TGL " + filterTglFormatted;
        
        document.getElementById('statTitle').innerText = titleStat;
        document.getElementById('statCash').innerText = "RP " + formatRibuan(tc);
        document.getElementById('statTf').innerText = "RP " + formatRibuan(tf);
        document.getElementById('statGrand').innerText = "RP " + formatRibuan(gt);

        // --- Logic Lainnya Tetap Jalan (Stok & Bestseller) ---
        let lakuAll = {}; db.catalog.forEach(v => lakuAll[v.nama] = 0);
        db.rekap.forEach(ot => { ot.items.forEach(b => { lakuAll[b.nama] = (lakuAll[b.nama] || 0) + b.qty; }); });

        const maxLaku = Math.max(...Object.values(lakuAll), 1);
        document.getElementById('bestSellerGrid').innerHTML = db.catalog
            .filter(v => lakuAll[v.nama] > 0)
            .sort((a,b) => lakuAll[b.nama] - lakuAll[a.nama])
            .map(v => {
                const isSaldo = v.nama.includes("LINKAJA") || v.nama.includes("SEVEN");
                const unit = isSaldo ? "Rp" : "PCS";
                return `
                <div style="margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:800; margin-bottom:8px;">
                        <span>${v.nama}</span><span>${isSaldo ? formatRibuan(lakuAll[v.nama]) : lakuAll[v.nama]} ${unit}</span>
                    </div>
                    <div style="height:8px; background:#eee; border-radius:10px;">
                        <div style="height:100%; background:var(--tsel-red); width:${(lakuAll[v.nama]/maxLaku)*100}%; border-radius:10px;"></div>
                    </div>
                </div>`}).join('');

        document.getElementById('stokTableBody').innerHTML = db.catalog.map(v => {
            const awal = db.stok[v.nama] || 0;
            const sisa = awal - (lakuAll[v.nama] || 0);
            const isSaldo = v.nama.includes("LINKAJA") || v.nama.includes("SEVEN");
            const dispAwal = isSaldo ? '-' : formatRibuan(awal);
            const dispSisa = isSaldo ? '-' : formatRibuan(sisa);
            const dispLaku = isSaldo ? formatRibuan(lakuAll[v.nama]||0) : (lakuAll[v.nama]||0);

            return `<tr><td>${v.nama}</td><td>${dispAwal}</td><td style="color:red;">${dispLaku}</td><td>${dispSisa}</td></tr>`;
        }).join('');

        document.getElementById('stokEditor').innerHTML = db.catalog.map(v => {
            if(v.nama.includes("LINKAJA") || v.nama.includes("SEVEN")) return ''; 
            return `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <label style="margin:0;">${v.nama}</label>
                <input type="number" style="width:120px; margin:0; padding:10px;" value="${db.stok[v.nama]||0}" oninput="updateSingleStok('${v.nama}', this.value)">
            </div>`;
        }).join('');
        document.getElementById('catalogList').innerHTML = db.catalog.map((v, i) => `
            <div style="display:flex; justify-content:space-between; padding:15px; background:rgba(128,128,128,0.05); border-radius:15px; margin-bottom:8px; font-weight:800;">
                <span>${v.nama} - ${formatRibuan(v.harga)}</span>
                <span onclick="db.catalog.splice(${i},1);saveToDisk();renderAll()" style="color:red; cursor:pointer;">HAPUS</span>
            </div>`).join('');
            
        renderRiwayat();
    }
    
    // --- FUNGSI TAB RIWAYAT + TOMBOL LIHAT DETAIL ---
    function renderRiwayat() {
        let dailySummary = {};
        db.rekap.forEach(trx => {
            if (!dailySummary[trx.tgl]) { dailySummary[trx.tgl] = { cash: 0, tf: 0, total: 0 }; }
            let subtotal = trx.items.reduce((sum, item) => sum + (item.harga * item.qty), 0);
            dailySummary[trx.tgl].total += subtotal;
            if (trx.metode === "CASH") dailySummary[trx.tgl].cash += subtotal; else dailySummary[trx.tgl].tf += subtotal;
        });

        let sortedDates = Object.keys(dailySummary).sort((a, b) => {
            let da = a.split('-').reverse().join('-');
            let db = b.split('-').reverse().join('-');
            return db.localeCompare(da);
        });

        let html = "";
        if (sortedDates.length === 0) {
            html = "<p style='text-align:center; color:#888;'>Belum ada riwayat transaksi.</p>";
        } else {
            sortedDates.forEach(date => {
                let d = dailySummary[date];
                // Konversi format DD-MM-YYYY ke YYYY-MM-DD untuk fungsi viewHistory
                let parts = date.split('-');
                let isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                
                html += `
                <div class="hist-row">
                    <div>
                        <div class="hist-date">${date}</div>
                        <div class="hist-detail">Cash: ${formatRibuan(d.cash)} | TF: ${formatRibuan(d.tf)}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="hist-total">Rp ${formatRibuan(d.total)}</div>
                        <button class="btn-view" onclick="viewHistory('${isoDate}')">üëÅÔ∏è LIHAT DETAIL</button>
                    </div>
                </div>`;
            });
        }
        document.getElementById('riwayatList').innerHTML = html;
    }

    // FUNGSI UNTUK MELOMPAT KE TAB 1 DAN BUKA TANGGAL TERSEBUT
    function viewHistory(isoDate) {
        document.getElementById('filterTgl').value = isoDate;
        renderAll(); // Refresh tampilan Tab 1 sesuai tanggal
        openTab('tab1', document.querySelectorAll('.tab-btn')[0]); // Pindah ke Tab 1
        window.scrollTo(0, document.body.scrollHeight); // Scroll ke bawah biar langsung liat list
    }

    function updateSingleStok(nama, val) { db.stok[nama] = parseInt(val) || 0; saveToDisk(); renderAll(); }

    function showStruk(i) {
        const ot = db.rekap[i]; let sub = 0;
        document.getElementById('rOutletName').innerText = ot.nama;
        document.getElementById('rDateDisp').innerText = ot.tgl + " | " + (ot.jam || "--:--") + " | " + ot.metode;
        let h = "", wa = `*${ot.nama}*\nTanggal: ${ot.tgl} ${ot.jam || ""}\n--------------------------\n`;
        ot.items.forEach(it => {
            const tot = it.harga * it.qty; sub += tot;
            const isSaldo = it.nama.includes("LINKAJA") || it.nama.includes("SEVEN");
            const detailStruk = isSaldo ? `*SALDO*` : `${it.qty} x ${formatRibuan(it.harga)}`;
            const hargaStruk = formatRibuan(tot);
            h += `<tr><td class="col-item">${it.nama}<br><small style="font-weight:normal;">${detailStruk}</small></td><td class="col-price">${hargaStruk}</td></tr>`;
            wa += `${it.nama} : ${isSaldo ? 'Rp '+formatRibuan(it.qty) : it.qty+' Pcs'} = ${hargaStruk}\n`;
        });
        wa += `--------------------------\n*TOTAL: RP ${formatRibuan(sub)}*`;
        document.getElementById('rItemsList').innerHTML = h;
        document.getElementById('rTotalAmount').innerText = "RP " + formatRibuan(sub);
        document.getElementById('waBtn').onclick = () => window.open(`https://wa.me/?text=${encodeURIComponent(wa)}`);
        document.getElementById('receiptOverlay').style.display = 'block';
    }

    function saveTrx() {
        const nama = document.getElementById('namaOutlet').value.toUpperCase();
        if(!nama || tempItems.length === 0) return alert("DATA TIDAK LENGKAP!");
        const now = new Date();
        const jamSekarang = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        const tglInput = document.getElementById('tanggalInput').value.split('-').reverse().join('-');
        const data = { nama, metode: document.getElementById('metodeBayar').value, items: [...tempItems], jam: jamSekarang, tgl: tglInput };
        if(editIdx > -1) { db.rekap[editIdx] = data; editIdx = -1; document.getElementById('mainSaveBtn').innerText = "üíæ SIMPAN TRANSAKSI SELESAI"; }
        else { db.rekap.push(data); }
        tempItems = []; document.getElementById('namaOutlet').value = "";
        renderTemp(); renderAll(); saveToDisk();
    }

    function copyReport() {
        let filterTglRaw = document.getElementById('filterTgl').value;
        let tglParts = filterTglRaw.split('-');
        let tgl = tglParts[2] + '-' + tglParts[1] + '-' + tglParts[0];
        let filteredData = db.rekap.filter(item => item.tgl === tgl);
        if(filteredData.length === 0) return alert("Belum ada data transaksi di tanggal " + tgl);

        let txt = `*LAPORAN PENJUALAN*\nTANGGAL : ${tgl}\n\n`;
        let totalCash = 0; let cashTrx = filteredData.filter(x => x.metode === 'CASH');
        if(cashTrx.length > 0) {
            txt += `*== PEMBAYARAN CASH ==*\n`;
            cashTrx.forEach(ot => {
                txt += `\n*${ot.nama}* (${ot.jam})\n`;
                let sub = 0;
                ot.items.forEach(it => {
                    let sum = it.harga * it.qty; sub += sum;
                    const isSaldo = it.nama.includes("LINKAJA") || it.nama.includes("SEVEN");
                    const unit = isSaldo ? "Rp" : "PCS";
                    txt += `${it.nama} : ${isSaldo ? formatRibuan(it.qty) : it.qty} ${unit} = ${formatRibuan(sum)}\n`;
                });
                totalCash += sub; txt += `Total: Rp ${formatRibuan(sub)}\n`;
            });
            txt += `\n*TOTAL CASH: RP ${formatRibuan(totalCash)}*\n----------------------------------\n`;
        }
        let totalTf = 0; let tfTrx = filteredData.filter(x => x.metode === 'TRANSFER');
        if(tfTrx.length > 0) {
            txt += `\n*== PEMBAYARAN TRANSFER ==*\n`;
            tfTrx.forEach(ot => {
                txt += `\n*${ot.nama}* (${ot.jam})\n`;
                let sub = 0;
                ot.items.forEach(it => {
                    let sum = it.harga * it.qty; sub += sum;
                    const isSaldo = it.nama.includes("LINKAJA") || it.nama.includes("SEVEN");
                    const unit = isSaldo ? "Rp" : "PCS";
                    txt += `${it.nama} : ${isSaldo ? formatRibuan(it.qty) : it.qty} ${unit} = ${formatRibuan(sum)}\n`;
                });
                totalTf += sub; txt += `Total: Rp ${formatRibuan(sub)}\n`;
            });
            txt += `\n*TOTAL TRANSFER: RP ${formatRibuan(totalTf)}*\n----------------------------------\n`;
        }
        txt += `\n*GRAND TOTAL: RP ${formatRibuan(totalCash + totalTf)}*`;
        navigator.clipboard.writeText(txt).then(() => alert("LAPORAN BERHASIL DISALIN!\n(Sudah dipisah Cash & Transfer)"));
    }

    function copyStockReport() {
        let tgl = document.getElementById('filterTgl').value.split('-').reverse().join('-');
        let txt = `*LAPORAN STOK HARIAN*\nTANGGAL: ${tgl}\n\n`;
        let lakuAll = {};
        db.rekap.forEach(ot => { ot.items.forEach(it => { lakuAll[it.nama] = (lakuAll[it.nama] || 0) + it.qty; }); });
        db.catalog.forEach(v => {
            const isSaldo = v.nama.includes("LINKAJA") || v.nama.includes("SEVEN");
            const awal = db.stok[v.nama] || 0; const laku = lakuAll[v.nama] || 0; const sisa = awal - laku;
            txt += `*${v.nama}*\n`;
            if(isSaldo) { txt += `Total Penjualan: Rp ${formatRibuan(laku)}\n\n`; } 
            else { txt += `Awal: ${awal} | Laku: ${laku} | Sisa: ${sisa}\n\n`; }
        });
        navigator.clipboard.writeText(txt).then(() => alert("DATA STOK BERHASIL DISALIN!"));
    }

    function setTgl() { 
        const d = new Date(); 
        let isoDate = (new Date(d - d.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
        document.getElementById('tanggalInput').value = isoDate; 
        document.getElementById('filterTgl').value = isoDate;
        renderAll();
    }
    
    function formatRibuan(n) { return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function parseNo(s) { return parseInt(s.toString().replace(/\./g, '')) || 0; }
    function formatInput(el) { el.value = formatRibuan(parseNo(el.value)); }
    
    function updateHarga() { 
        const sel = document.getElementById('pilihanVoucher');
        const nama = sel.options[sel.selectedIndex].text;
        if(nama.includes("LINKAJA") || nama.includes("SEVEN")) {
            document.getElementById('labelQty').innerText = "NOMINAL (RP)";
            document.getElementById('jumlahPcs').placeholder = "0"; 
            document.getElementById('hargaDisplay').value = "1"; 
        } else {
            document.getElementById('labelQty').innerText = "QTY (PCS)";
            document.getElementById('jumlahPcs').placeholder = "0";
            document.getElementById('hargaDisplay').value = formatRibuan(sel.value);
        }
    }

    function openTab(id, btn) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); btn.classList.add('active');
    }

    function addItem() {
        const sel = document.getElementById('pilihanVoucher');
        const qty = parseNo(document.getElementById('jumlahPcs').value);
        if(!qty) return;
        tempItems.push({nama: sel.options[sel.selectedIndex].text, harga: parseNo(document.getElementById('hargaDisplay').value), qty: qty});
        document.getElementById('jumlahPcs').value = ""; renderTemp();
    }

    function renderTemp() {
        document.getElementById('tempList').innerHTML = tempItems.map((it, i) => {
            const isSaldo = it.nama.includes("LINKAJA") || it.nama.includes("SEVEN");
            return `<div style="background:rgba(128,128,128,0.1); padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; font-weight:800; font-size:13px;">
                <span>${it.nama} (${isSaldo ? 'Rp ' + formatRibuan(it.qty) : it.qty + ' Pcs'})</span>
                <span onclick="tempItems.splice(${i},1);renderTemp()" style="color:red; cursor:pointer;">√ó</span>
            </div>`}).join('');
    }

    function editTrx(i) {
        const d = db.rekap[i]; document.getElementById('namaOutlet').value = d.nama; document.getElementById('metodeBayar').value = d.metode;
        tempItems = [...d.items]; editIdx = i; document.getElementById('mainSaveBtn').innerText = "‚úÖ UPDATE DATA OUTLET";
        openTab('tab1', document.querySelectorAll('.tab-btn')[0]); renderTemp();
    }
    function delTrx(i) { if(confirm("Hapus transaksi?")) { db.rekap.splice(i,1); saveToDisk(); renderAll(); } }
    function addKatalog() {
        const n = document.getElementById('addName').value.toUpperCase();
        const p = parseNo(document.getElementById('addPrice').value);
        if(!n || !p) return;
        db.catalog.push({nama:n, harga:p}); saveToDisk(); renderAll();
        document.getElementById('addName').value=""; document.getElementById('addPrice').value="";
    }
    function toggleTheme() {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
    }
    function exportData() {
        const blob = new Blob([JSON.stringify(db)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `MSP_DATABASE.json`; a.click();
    }
    function importData(e) {
        const reader = new FileReader();
        reader.onload = (f) => { db = JSON.parse(f.target.result); saveToDisk(); renderAll(); alert("RESTORE BERHASIL!"); };
        reader.readAsText(e.target.files[0]);
    }
    function closeReceipt() { document.getElementById('receiptOverlay').style.display = 'none'; }
    function hardReset() { if(confirm("HAPUS SEMUA DATA?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
